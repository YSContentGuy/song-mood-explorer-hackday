<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Song Mood Explorer ‚Äî Basic Demo</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#f5f7fb; margin:0; padding:24px; }
    .wrap { max-width: 1000px; margin: 0 auto; }
    h1 { margin:0 0 6px; }
    .sub { color:#666; margin-bottom: 16px; }
    .buttons { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .userbtn { background:#fff; border:2px solid #e9ecf3; border-radius:14px; padding:16px; text-align:center; cursor:pointer; font-size:16px; }
    .userbtn:hover { box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .userbtn .mini { display:block; color:#777; font-size:12px; margin-top:6px; }
    .panel { margin-top:16px; background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; }
    .row { margin-top:8px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 800px) { .grid2 { grid-template-columns: 1fr; } }
    .title { font-weight:700; font-size:18px; }
    .muted { color:#777; font-size:12px; }
    .song { margin-top:8px; border-left:4px solid #667eea; padding-left:10px; }
    .actions { margin-top: 8px; }
    .btn { background:#e9ecff; color:#2d3a8c; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .ai-explanation { background:#f0f8ff; border-left:3px solid #007AFF; padding:8px 12px; margin-top:8px; border-radius:4px; font-size:14px; color:#333; }
    @media (max-width: 800px) { .buttons { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Song Mood Explorer</h1>
    <div class="sub">AI-Enhanced Music Recommendations with Behavioral Intelligence</div>
    
    <div class="sub">Three user profiles. Click one to see how our system analyzes behavioral patterns (how users actually play songs) to infer mood and provide intelligent recommendations.</div>
    
    <div style="background:#e8f4fd; border:1px solid #b3d9ff; border-radius:8px; padding:12px; margin:16px 0; font-size:14px;">
      <div style="font-weight:600; margin-bottom:8px;">üìä Understanding the Scores:</div>
      <div style="color:#555; line-height:1.5;">
        <div style="margin-bottom:8px;"><strong>üéØ Overall Match (0-100%):</strong> The final score combining all factors - how well this song fits you overall</div>
        <div style="margin-bottom:8px;"><strong>üè† Comfort Zone (0-100%):</strong> How familiar you are with this musical style and difficulty level based on your past playing (combines both style and difficulty comfort)</div>
        <div style="margin-bottom:8px;"><strong>üòä Mood Match (0-100%):</strong> How well the song's emotional energy and style matches your current mood (inferred from your playing patterns)</div>
        <div style="margin-bottom:8px;"><strong>üìà Playing Patterns:</strong> Shows your actual playing behavior - songs you return to, styles you play most, typical difficulty, comfort zone difficulty range, comfort zone styles, and learning style</div>
      </div>
    </div>
    <div id="buttons" class="buttons">Loading‚Ä¶</div>
    <div id="panel" class="panel" style="display:none"></div>
  </div>
  <script>
    let overview = null;
    
    async function load() {
      const buttons = document.getElementById('buttons');
      buttons.textContent = 'Loading‚Ä¶';
      try {
        const res = await fetch('/api/demo/users-overview', { cache: 'no-store' });
        overview = await res.json();
        renderButtons();
        // Auto-open the first user to show content immediately
        if (overview.users && overview.users.length > 0) {
          showUser(overview.users[0].id);
        }
      } catch (e) {
        // Offline fallback so the demo always shows something
        overview = { users: [
          { id: 'user_beginner', name: 'Sarah (Beginner)', blurb: 'Beginner ¬∑ Likes pop, acoustic, folk', derivedMood: 'relaxed', context: { timeOfDay: 'evening', goals: 'relax' }, user: { skillLevel: 2 }, suggestion: { SONG_TITLE: 'Cleaning Windows', ARTIST_NAME: 'Van Morrison', energy_level: 'medium', difficulty_level: 4, contextualScore: 0.54, scoringBreakdown: { moodAlignment: 0.5 } } },
          { id: 'user_intermediate', name: 'Mike (Intermediate)', blurb: 'Intermediate ¬∑ Likes rock, alternative, indie', derivedMood: 'energetic', context: { timeOfDay: 'afternoon', goals: 'challenge' }, user: { skillLevel: 5 }, suggestion: { SONG_TITLE: 'Butterflies', ARTIST_NAME: 'Zendaya', energy_level: 'high', difficulty_level: 4, contextualScore: 0.72, scoringBreakdown: { moodAlignment: 0.75 } } },
          { id: 'user_advanced', name: 'Alex (Advanced)', blurb: 'Advanced ¬∑ Likes metal, progressive, jazz', derivedMood: 'focused', context: { timeOfDay: 'morning', goals: 'challenge' }, user: { skillLevel: 8 }, suggestion: { SONG_TITLE: 'Here Comes The Sun', ARTIST_NAME: 'The Beatles', energy_level: 'high', difficulty_level: 7, contextualScore: 0.58, scoringBreakdown: { moodAlignment: 0.65 } } }
        ] };
        renderButtons();
      }
    }
    function renderButtons(){
      const buttons = document.getElementById('buttons');
      buttons.innerHTML = '';
      (overview.users || []).forEach(u => {
        const b = document.createElement('div');
        b.className = 'userbtn';
        const blurbMini = (u.blurb||'').split(' ¬∑ ').slice(0,2).join(' ¬∑ ');
        b.innerHTML = `${u.name}<span class='mini'>${blurbMini}</span>`;
        b.onclick = () => showUser(u.id);
        buttons.appendChild(b);
      });
    }
    function whyLine(item, suggestion){
      const s = suggestion || {};
      const b = s.scoringBreakdown || {};
      const parts = [];
      
      // Context explanation
      if (item?.context) {
        const timeContext = item.context.timeOfDay === 'morning' ? 'morning practice' : 
                           item.context.timeOfDay === 'afternoon' ? 'afternoon session' : 'evening practice';
        const goalContext = item.context.goals === 'challenge' ? 'looking to challenge yourself' : 'wanting to relax';
        parts.push(`Perfect for ${timeContext} when you're ${goalContext}`);
      }
      
      // Duration fit
      if (typeof s.duration === 'number' && item?.context?.availableTime) {
        const mins = Math.round(s.duration/60);
        parts.push(`${mins}-minute song fits your ${item.context.availableTime}-minute session`);
      }
      
      // Difficulty explanation
      if (typeof s.difficulty_level === 'number' && item?.user?.skillLevel) {
        const diff = s.difficulty_level - item.user.skillLevel;
        if (diff === 0) {
          parts.push('perfect difficulty match for your skill level');
        } else if (diff > 0) {
          parts.push(`${diff} levels above your skill (good challenge)`);
        } else {
          parts.push(`${Math.abs(diff)} levels below your skill (comfortable)`);
        }
      }
      
      return parts.join(' ‚Ä¢ ');
    }

    let rerollState = {};
    async function showUser(userId, offset){
      const panel = document.getElementById('panel');
      panel.style.display = 'block';
      panel.innerHTML = '<div class="muted">Working‚Ä¶</div>';
      const item = (overview.users || []).find(x => x.id === userId);
      let suggestion = null;
      let aiExplanation = null;
      // Always fetch fresh suggestions to get AI explanations
      if (item) {
        const mood = item?.derivedMood || 'neutral'; // Use behavioral analysis derived mood
        const timeOfDay = item?.context?.timeOfDay || 'evening';
        const goals = item?.context?.goals || (mood === 'energetic' ? 'challenge' : 'relax');
        const q = new URLSearchParams({ userId, mood, timeOfDay, availableTime: 20, goals, offset: offset || 0 });
        const res = await fetch('/api/demo/user-suggestion?' + q.toString());
        const data = await res.json();
        suggestion = data.suggestion || null;
        aiExplanation = data.aiExplanation || null;
        console.log('AI Explanation received:', aiExplanation);
      }
      if (!item) { panel.innerHTML = '<div class="muted">User not found</div>'; return; }
      if (!suggestion) {
        panel.innerHTML = `<div class='title'>${item.name}</div>
          <div class='muted'>${item.blurb}</div>
          <div class='song'><em>No suggestion found</em></div>`;
        return;
      }
      const prof = item.user || {};
      const sum = item.summary || {};
      const src = sum.source ? (' (' + sum.source + ')') : '';
      const s = suggestion || {};
      panel.innerHTML = `
        <div class='title'>${item.name}</div>
        <div class='grid2 row'>
          <div>
            <div><strong>Profile</strong></div>
            <div class='muted'>Skill: ${prof.skillLevel ?? 'n/a'}</div>
            <div class='muted'>Practice: ${prof.practiceFrequency || prof.practice || 'n/a'}</div>
            <div class='muted'>Pref. difficulty: ${(prof.preferredDifficulty ? (Array.isArray(prof.preferredDifficulty)? prof.preferredDifficulty.join(', ') : prof.preferredDifficulty) : 'n/a')} (based on app difficulty levels)</div>
            <div class='muted'>Genres: ${(prof.genrePreferences||prof.genres||[]).join(', ')}</div>
            <div class='muted'>Age: ${prof.age || 'n/a'}</div>
            <div class='muted'>Total songs played: ${prof.totalSongsPlayed || 'n/a'}</div>
            <div class='muted'>Subscription time: ${prof.subscriptionTime || 'n/a'}</div>
            <div class='muted'>Learning style: ${prof.learningStyle || 'n/a'}</div>
          </div>
          <div>
            <div><strong>Playing Patterns${src}</strong></div>
            <div class='muted' style='font-size:11px; color:#999; margin-bottom:4px;'>Analysis of how this user actually plays songs</div>
            <div class='muted'>Songs they return to: ${sum.count ?? 0}</div>
            <div class='muted'>Typical difficulty: ${sum.avgDifficulty ?? 'n/a'}</div>
            <div class='muted'>Comfort zone difficulty: ${(prof.comfortZoneDifficulty || []).join(', ')}</div>
            <div class='muted'>Comfort zone styles: ${(prof.comfortZoneStyles || []).join(', ')}</div>
            <div class='muted'>Preferred energy: ${sum.dominantEnergy || 'n/a'}</div>
            <div class='muted'>Styles they play most: ${(sum.topStyleTags||[]).slice(0,3).join(', ')}</div>
          </div>
        </div>
        <div class='row muted'>Inferred Mood: <strong>${item.derivedMood}</strong> ¬∑ Time: ${item.context.timeOfDay} ¬∑ Goal: ${item.context.goals}</div>
        <div class='song row'>
          <div><strong>${s.title || s.SONG_TITLE}</strong> ‚Äî ${s.artist || s.ARTIST_NAME || 'Unknown'}</div>
          
          <div style='margin-top:8px; padding:10px; background:#f8f9fa; border-radius:6px; font-size:13px;'>
            <div style='font-weight:600; margin-bottom:6px;'>üéØ Recommendation Scores:</div>
            <div style='display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:6px;'>
              <div class='muted'><strong>üéØ Overall Match:</strong><br/>${s.contextualScore ? Math.round(s.contextualScore*100)+'%' : 'N/A'}<br/><span style='font-size:11px; color:#888;'>Final combined score</span></div>
              <div class='muted'><strong>üè† Comfort Zone:</strong><br/>${(s.scoringBreakdown && typeof s.scoringBreakdown.comfortZone === 'number') ? Math.round(s.scoringBreakdown.comfortZone*100)+'%' : 'n/a'}<br/><span style='font-size:11px; color:#888;'>Style & difficulty familiarity</span></div>
            </div>
            <div style='display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:6px;'>
              ${(s.scoringBreakdown && typeof s.scoringBreakdown.moodAlignment === 'number') ? `<div class='muted'><strong>üòä Mood Match:</strong><br/>${Math.round(s.scoringBreakdown.moodAlignment*100)}%<br/><span style='font-size:11px; color:#888;'>Emotional energy match</span></div>` : '<div></div>'}
              <div class='muted'><strong>‚ö° Energy:</strong><br/>${s.energy_level || 'n/a'}<br/><span style='font-size:11px; color:#888;'>Song intensity</span></div>
            </div>
            <div class='muted'><strong>üé∏ Difficulty:</strong> ${s.difficulty_level ?? 'n/a'}/10 (based on app difficulty levels)</div>
          </div>
          
          <div class='muted' style='margin-top:6px; font-size:12px;'>${whyLine(item, s)}</div>
          ${aiExplanation ? `<div class='ai-explanation'><strong>ü§ñ AI Insight:</strong> ${aiExplanation.explanation}</div>` : '<div class="muted">No AI explanation available</div>'}
        </div>
        <div class='actions'><button class='btn' id='rerollBtn'>Reroll</button></div>
      `;
      // Wire reroll button to pick the next candidate in the list
      rerollState[userId] = (rerollState[userId] || 0) + 1;
      const btn = document.getElementById('rerollBtn');
      if (btn) btn.onclick = () => showUser(userId, rerollState[userId]);
    }
    load();
  </script>
</body>
</html>
